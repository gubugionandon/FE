name: Electron Build for PR

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/electron/**'
      - 'packages/**'
      - 'apps/web/**'
      - '.github/workflows/electron-build-pr.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  build-electron:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            os_short: mac
          - os: windows-latest
            os_short: win

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Cache turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ github.job }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ github.job }}-${{ github.ref_name }}-

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build web app for Electron renderer
        run: |
          cd apps/web
          npm run build
          echo "âœ… Web app built for Electron renderer"

      - name: Package Electron App
        run: npm run build:${{ matrix.os_short }} --workspace=electron-wrapper

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-${{ matrix.os }}-${{ github.event.number }}
          if-no-files-found: warn
          path: |
            apps/electron/dist/*.dmg
            apps/electron/dist/*.zip
            apps/electron/dist/*.exe
            apps/electron/dist/mac/**

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const os = '${{ matrix.os }}';
            const run = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const body = `
              ## ðŸ”§ Electron Build (${os})
              - **Status**: ${{ job.status }}
              - **Artifacts**: [View Build Artifacts](${run})
              ---
              *This is an automated comment.*
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });