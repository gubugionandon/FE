name: Electron Build for PR

on:
  pull_request_target:
    branches: ['main']
    paths:
      - 'apps/electron/**'
      - 'packages/**'
      - 'apps/web/**'
      - '.github/workflows/electron-build-pr.yml'

jobs:
  build-electron:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Debug info
        run: |
          echo "ğŸ” Debug Information:"
          echo "Event: ${{ github.event_name }}"
          echo "PR Number: ${{ github.event.number }}"
          echo "Head SHA: ${{ github.event.pull_request.head.sha }}"
          echo "Base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "Head Ref: ${{ github.head_ref }}"
          echo "Base Ref: ${{ github.base_ref }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json

      - name: Install workspace dependencies
        run: |
          # ì „ì²´ workspace ì˜ì¡´ì„± ì„¤ì¹˜ (husky ìŠ¤í¬ë¦½íŠ¸ ë¬´ì‹œ)
          npm ci --ignore-scripts

      - name: Build web app (Electron renderer)
        run: |
          cd apps/web
          npm run build
          echo "âœ… Web app built successfully"

      - name: Build Electron app
        run: |
          cd apps/electron
          npm run build
          echo "âœ… Electron main and preload built successfully"

      - name: Compile Electron (macOS)
        run: |
          cd apps/electron
          npm run build:mac
          echo "âœ… Electron macOS app compiled successfully"

      - name: Compile Electron (Windows)
        run: |
          cd apps/electron
          npm run build:win
          echo "âœ… Electron Windows app compiled successfully"

      - name: Upload macOS build artifact
        uses: actions/upload-artifact@v4
        with:
          name: electron-macos-${{ github.event.number }}
          path: apps/electron/dist/*.dmg
          retention-days: 30

      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: electron-windows-${{ github.event.number }}
          path: apps/electron/dist/*.exe
          retention-days: 30

      - name: Upload macOS app directory
        uses: actions/upload-artifact@v4
        with:
          name: electron-macos-app-${{ github.event.number }}
          path: apps/electron/dist/mac/
          retention-days: 30

      - name: Get build info
        id: build-info
        run: |
          cd apps/electron
          MACOS_SIZE=$(du -sh dist/*.dmg 2>/dev/null | cut -f1 || echo "N/A")
          WINDOWS_SIZE=$(du -sh dist/*.exe 2>/dev/null | cut -f1 || echo "N/A")
          
          echo "macos_size=$MACOS_SIZE" >> $GITHUB_OUTPUT
          echo "windows_size=$WINDOWS_SIZE" >> $GITHUB_OUTPUT
          
          # ë¹Œë“œëœ íŒŒì¼ ëª©ë¡
          echo "macos_files=$(ls -la dist/*.dmg 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          echo "windows_files=$(ls -la dist/*.exe 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT

      - name: Comment PR with build results
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // ê¸°ì¡´ ëŒ“ê¸€ ì‚­ì œ
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ğŸ”§ Electron Build Results')
            );
            
            if (botComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
              });
            }
            
            // ìƒˆë¡œìš´ ëŒ“ê¸€ ì‘ì„±
            const comment = `## ğŸ”§ Electron Build Results
            
            ### âœ… ë¹Œë“œ ì™„ë£Œ!
            
            **PR #${{ github.event.number }}** ì— ëŒ€í•œ Electron ì•± ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ### ğŸ“¦ ë¹Œë“œ ê²°ê³¼
            
            | í”Œë«í¼ | ìƒíƒœ | íŒŒì¼ í¬ê¸° | ë‹¤ìš´ë¡œë“œ |
            |--------|------|-----------|----------|
            | ğŸ macOS | âœ… ì„±ê³µ | ${{ steps.build-info.outputs.macos_size }} | [ë‹¤ìš´ë¡œë“œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
            | ğŸªŸ Windows | âœ… ì„±ê³µ | ${{ steps.build-info.outputs.windows_size }} | [ë‹¤ìš´ë¡œë“œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
            
            ### ğŸ“‹ ë¹Œë“œ ì •ë³´
            
            - **ì»¤ë°‹**: \`${{ github.sha }}\`
            - **ë¸Œëœì¹˜**: \`${{ github.head_ref }}\`
            - **ë¹Œë“œ ì‹œê°„**: \`${{ steps.build-info.outputs.build_time }}\`
            - **Node.js**: \`20.x\`
            - **Electron**: \`32.0.0\`
            
            ### ğŸš€ ë‹¤ìš´ë¡œë“œ ë°©ë²•
            
            1. ìœ„ì˜ "ë‹¤ìš´ë¡œë“œ" ë§í¬ë¥¼ í´ë¦­
            2. "Artifacts" ì„¹ì…˜ì—ì„œ ì›í•˜ëŠ” í”Œë«í¼ ì„ íƒ
            3. íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ í…ŒìŠ¤íŠ¸
            
            ### ğŸ“ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸
            
            - [ ] Flutter ì•±ì´ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ëŠ”ì§€ í™•ì¸
            - [ ] ë©”ë‰´ë°” ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
            - [ ] ìœˆë„ìš° í¬ê¸° ì¡°ì ˆì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
            - [ ] ê°œë°œì ë„êµ¬ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
            
            ---
            *ì´ ëŒ“ê¸€ì€ GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment,
            });

      - name: Build summary
        run: |
          echo "âœ… Electron build completed successfully!"
          echo "ğŸ“¦ macOS build: ${{ steps.build-info.outputs.macos_size }}"
          echo "ğŸ“¦ Windows build: ${{ steps.build-info.outputs.windows_size }}"
          echo "ğŸ”— PR Comment: Added build results to PR #${{ github.event.number }}"
